# リソースパック方式の分析

このドキュメントは、*R-Type Tactics II* のリソースのパック・アンパックに関する技術的な詳細を紹介します。技術的な内容に興味のある方向けです。  
単に解凍したいだけの場合は、`extract_rtt2_dat.py` スクリプトを使用するだけで十分で、これらの詳細を理解する必要はありません。

研究を行った時期とこの文書の作成時期にはタイムラグがあるため、内容に漏れや誤りが含まれる可能性があります。スクリプト作成時の [ChatGPTとの元の会話](https://chatgpt.com/share/680303d4-fa94-800e-b3fb-d1c977266b5e) を公開しているので、参考にしてください。

## メインDAT/FATファイル

`PSP_GAME\USRDIR\CMN` フォルダ内の `CMN.DAT` と `CMN.FAT` を指します。  
`CMN.FAT` はファイル名、サイズ、位置などの情報を記録し、`CMN.DAT` は実際のファイルデータを格納します。

### メインFATファイル

このファイルは `256バイトのヘッダー` + `ファイル情報セクション` + `ファイル名セクション` で構成されています。

#### ヘッダー

- 先頭は固定文字列 `FAT `
- `0xF8` の位置には、ファイル情報セクションの終了位置を示す32ビット整数があります。

#### ファイル情報セクション

各ファイルの情報は16バイト（32ビット整数×4）で構成：

`DAT内でのファイル開始位置`、`ファイルサイズ`、`0000`、`FAT内でのファイル名の位置`

#### ファイル名セクション

文字列長を示す変数はなく、ファイル名は `0x00`（NULL）で終了します。

### メインDATファイル

複数のリソースファイルが連結されている1つの大きなファイル。各ファイルの位置とサイズは `CMN.FAT` に記録されています。

## サブDAT/FATファイル

これは *メインDAT/FATファイル* から抽出された *DAT/FATファイル* で、フォルダやアーカイブのように機能します。

### サブFATファイル

*メインFATファイル* とほぼ同じ構造ですが、いくつか重要な違いがあります：

- 対応する `.DAT` ファイルを持つものは少なく、大部分の `.FAT` ファイルには `ファイル名セクション` の後に `ファイル内容セクション` が続きます（`.DAT` を後ろにくっつけた構成）。
- 上記のような場合、`0xFC` の位置にファイル内容セクションの開始位置が記録されており、0ではありません。
- ファイル名に `/` が含まれることがあります。スクリプトではパフォーマンスのためにフォルダは作成しません。
- 実際のファイル位置 = ファイル内容セクションの開始位置 + ファイルの開始オフセット
- `.FAT` 内のファイルは **GZIP圧縮** されています

### サブDATファイル

*メインDATファイル* と完全に同じフォーマットです。

## XIMおよびXMOファイル

これらはテクスチャ、アニメーション、モデルを格納するファイルで、少し処理が必要です。

### XIMファイル

`.XIM` ファイルは実質的に `.GIM` ファイルです。拡張子を `.GIM` に変更すると読み取りやすくなります。

### XMOファイル

`.XMO` ファイルは GZIP圧縮された `.GMO` ファイルで、4バイトの追加ヘッダーがあり、GZIPデータは `0x04` から始まります。
