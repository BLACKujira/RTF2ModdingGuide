# 资源打包方式分析

这一篇是关于 *R-Type Tactics II* 打包 & 解包的技术细节，供有兴趣的人阅读。如果只是要解包解包的话使用脚本 `extract_rtt2_dat.py` 就够用了，不需要了解这些细节。

由于研究的时间距离此文档编写的时间较长，我可能会遗漏或记错一些内容。我公开了编写脚本时 [和ChatGPT的原始对话](https://chatgpt.com/share/680303d4-fa94-800e-b3fb-d1c977266b5e) 方便大家寻找错漏的信息。

## 主DAT/FAT文件

这里指的是 `PSP_GAME\USRDIR\CMN` 中的 `CMN.DAT` 和 `CMN.FAT` 两个文件。其中 `CMN.FAT` 负责记录文件名、文件大小、文件位置等信息，而 `CMN.DAT` 存储文件本身。

### 主FAT文件

这个文件由 `256字节的头部` + `文件信息部分` + `文件名部分` 组成。

#### 头部

- 开头为固定的 `FAT `
- `0xF8` 处是一个32位整数，标记文件信息部分的结束位置

#### 文件信息部分

每一个文件的信息占16字节，由4个 *32位整数* 构成，分别为：

`文件在.DAT中的起始位置`，`文件大小`，`0000`，`文件名在.FAT的起始位置`

#### 文件名部分

没有用于标记字符串长度的变量，文件名字符串以 `0x00` 结尾。

### 主DAT文件

由许多资源文件拼接成的一整个文件，每个文件的起始位置和大小在 `CMN.FAT` 中，

## 子DAT/FAT文件

这里指的是 *主DAT/FAT文件* 中解包出的 *DAT/FAT文件* ，这些文件的作用类似于文件夹或压缩文件。

### 子FAT文件

与 *主FAT文件* 基本相同，但有一些很重要的区别

- 只有极少数 *子FAT文件* 有对应的 `.DAT` 文件，大部分 *子FAT文件* 在 `文件名部分` 后还有一个 `文件内容部分`，相当于将 `.DAT` 拼接在了后面。
- 如果是上述含有文件内容的 `.FAT` 文件，则 `0xFC` 的位置不为0，而是记录 `文件内容部分` 的起始位置。
- 文件名中可能含有 `/` 。在脚本中为了性能没有创建新文件夹。
- 文件的实际位置 = 文件内容部分的起始位置 + 文件的起始位置
- `.FAT` 文件中的文件内容 **经过GZIP压缩**

### 子DAT文件

与 *主DAT文件* 完全相同

## XIM和XMO文件

这些是解包出的储存贴图、动画、模型的文件，需要稍微处理一下。

### XIM文件

`.XIM文件` 就是 `.GIM文件`，将其扩展名重命名为 `.GIM` 方便读取。

### XMO文件

`.XMO文件` 是经过GZIP压缩的 `.GMO文件`，有一个额外的4字节文件头，GZIP数据从 `0x04` 处开始。